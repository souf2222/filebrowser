# FileBrowser Docker Compose Configuration
# Copy this file to docker-compose.yml and customize as needed

version: '3.8'

# ============================================================
# SERVICES
# ============================================================

services:
  # ----------------------------------------------------
  # FILEBROWSER SERVICE
  # ----------------------------------------------------
  filebrowser:
    # Build image from local source
    build:
      context: .
      dockerfile: _docker/Dockerfile.slim
      args:
        # Optional: Specify version and revision
        # VERSION: "testing"
        # REVISION: "local"

    container_name: filebrowser
    restart: unless-stopped
    stop_grace_period: 30s

    # Enable Traefik labels for automatic discovery
    labels:
      - "traefik.enable=true"
      # HTTP router
      - "traefik.http.routers.filebrowser-http.rule=Host(`files.example.com`)"
      - "traefik.http.routers.filebrowser-http.entrypoints=http"
      - "traefik.http.routers.filebrowser-http.service=filebrowser"
      # HTTPS router with automatic SSL
      - "traefik.http.routers.filebrowser-https.rule=Host(`files.example.com`)"
      - "traefik.http.routers.filebrowser-https.entrypoints=https"
      - "traefik.http.routers.filebrowser-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.filebrowser-https.service=filebrowser"
      # Redirect HTTP to HTTPS
      - "traefik.http.routers.filebrowser-http.middlewares=redirect-https@fileproxy"
      # FileBrowser service configuration
      - "traefik.http.services.filebrowser.loadbalancer.server.port=80"
      # Health check for Traefik
      - "traefik.http.services.filebrowser.loadbalancer.healthcheck.path=/health"
      - "traefik.http.services.filebrowser.loadbalancer.healthcheck.interval=30s"

    # Connect to Traefik network
    networks:
      - fb_network

    # ----------------------------------------------------
    # VOLUME MOUNTS
    # ----------------------------------------------------
    volumes:
      # REQUIRED: File storage location
      # Replace 'files:/srv' with one of these options:
      #
      # Option A: Named volume (data persists in Docker)
      #   files:/srv
      #
      # Option B: Host directory (recommended for large file collections)
      #   Add your path below:
      #   - /path/to/your/files:/srv

      # Default: Named volume (change this to your file location)
      - files:/srv

      # Database volume (persists database across rebuilds)
      - database:/database

      # Config volume (persists settings across rebuilds)
      - config:/config

    # ----------------------------------------------------
    # ENVIRONMENT VARIABLES
    # ----------------------------------------------------
    environment:
      # Database location (default path inside container)
      - FB_DATABASE=/database/filebrowser.db

      # Optional: Custom configuration file
      # - FB_CONFIG=/config/settings.json

    # ----------------------------------------------------
    # HEALTHCHECK
    # ----------------------------------------------------
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ----------------------------------------------------
  # TRAEFIK REVERSE PROXY
  # ----------------------------------------------------
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    command:
      # Global configuration
      - "--global.checknewversion=false"
      - "--global.sendanonymoususage=false"
      # API configuration
      - "--api.insecure=true"
      # Dashboard (access at http://your-domain:8080)
      - "--api.dashboard=true"
      # Entry points
      - "--entrypoints.http.address=:80"
      - "--entrypoints.https.address=:443"
      # Let's Encrypt configuration
      - "--certificatesresolvers.letsencrypt.acme.email=your-email@example.com"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=http"
      # Docker provider
      - "--providers.docker=true"
      - "--providers.docker.network=fb_network"
      - "--providers.docker.exposedbydefault=false"
      # Logging
      - "--log.level=INFO"

    ports:
      # HTTP port (redirects to HTTPS)
      - "80:80"
      # HTTPS port
      - "443:443"
      # Traefik dashboard (optional - remove if not needed)
      - "8080:8080"

    volumes:
      # Mount Docker socket for provider
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Let's Encrypt certificates storage
      - letsencrypt:/letsencrypt
      # Traefik static configuration
      - ./traefik/traefik.yml:/traefik.yml:ro
      # Optional: Dynamic configuration
      # - ./traefik/dynamic.yml:/dynamic.yml:ro

    networks:
      - fb_network
    labels:
      # Enable Traefik on this container
      - "traefik.enable=true"
      # Dashboard
      - "traefik.http.routers.traefik-http.rule=Host(`traefik.example.com`)"
      - "traefik.http.routers.traefik-http.entrypoints=http"
      - "traefik.http.routers.traefik-http.service=api@internal"
      - "traefik.http.routers.traefik-http.middlewares=auth@file"
      # HTTPS for dashboard
      - "traefik.http.routers.traefik-https.rule=Host(`traefik.example.com`)"
      - "traefik.http.routers.traekik-https.entrypoints=https"
      - "traefik.http.routers.traefik-https.tls.certresolver=letsencrypt"
      - "traefik.http.routers.traefik-https.service=api@internal"

    # Optional: Basic auth middleware for dashboard
    # Create with: echo $(htpasswd -nb user "password") | sed 's/$/\\n/'
    # Or use traefik-forward-auth for OAuth

  # ----------------------------------------------------
  # OPTIONAL: TRAEFIK FORWARD AUTH (OAuth)
  # ----------------------------------------------------
  # Uncomment to enable OAuth authentication via Traefik
  # Requires authelia or similar OIDC provider
  #
  # traefik-forward-auth:
  #   image: mesosphere/traefik-forward-auth:latest
  #   container_name: traefik-forward-auth
  #   restart: unless-stopped
  #   environment:
  #     - TRAEFIK_ADDRESS=http://traefik:80
  #     - AUTH_HOST=auth.example.com
  #     - OIDC_ISSUER_URL=https://your-oidc-provider.com
  #     - OIDC_CLIENT_ID=your-client-id
  #     - OIDC_CLIENT_SECRET=your-client-secret
  #     - SECRET=your-random-secret-key
  #   networks:
  #     - fb_network
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.auth-http.rule=Host(`auth.example.com`)"
  #     - "traefik.http.routers.auth-http.entrypoints=http"
  #     - "traefik.http.routers.auth-https.rule=Host(`auth.example.com`)"
  #     - "traefik.http.routers.auth-https.entrypoints=https"
  #     - "traefik.http.routers.auth-https.tls.certresolver=letsencrypt"
  #     - "traefik.http.services.auth.loadbalancer.server.port=4181"

# ============================================================
# NETWORKS
# ============================================================
networks:
  fb_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================
# VOLUMES
# ============================================================
volumes:
  # File storage volume
  files:
    driver: local

  # Database volume
  database:
    driver: local

  # Config volume
  config:
    driver: local

  # Let's Encrypt certificates volume
  letsencrypt:
    driver: local

# ============================================================
# TRAEFIK CONFIGURATION FILE
# ============================================================
# Create this file as: traefik/traefik.yml
# ----------------------------------------------------
# global:
#   checkNewVersion: false
#   sendAnonymousUsage: false
#
# api:
#   dashboard: true
#   insecure: true
#
# providers:
#   docker:
#     endpoint: "unix:///var/run/docker.sock"
#     network: "fb_network"
#     exposedByDefault: false
#   file:
#     directory: "/dynamic"
#     watch: true
#
# entryPoints:
#   http:
#     address: ":80"
#     http:
#       redirections:
#         entryPoint:
#           to: https
#           scheme: https
#           permanent: true
#   https:
#     address: ":443"
#
# certificatesResolvers:
#   letsencrypt:
#     acme:
#       email: "your-email@example.com"
#       storage: "/letsencrypt/acme.json"
#       httpChallenge:
#         entryPoint: http
#
# log:
#   level: INFO
# ----------------------------------------------------

# ============================================================
# TRAEFIK DYNAMIC CONFIGURATION (Optional)
# ============================================================
# Create this file as: traefik/dynamic.yml
# ----------------------------------------------------
# http:
#   routers:
#     dashboard:
#       rule: "Host(`traefik.example.com`)"
#       service: api@internal
#       middlewares:
#         - auth
#
#   middlewares:
#     auth:
#       basicAuth:
#         users:
#           - "admin:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/"
#     redirect-https:
#       redirectScheme:
#         scheme: https
#         permanent: true
#
#   services:
#     api:
#       loadBalancer:
#         servers:
#           - url: "http://localhost:8080"
# ----------------------------------------------------

# ============================================================
# USAGE EXAMPLES
# ============================================================

# 1. BASIC TRAEFIK DEPLOYMENT
# ----------------------------------------
# Step 1: Create traefik/traefik.yml (see above)
# Step 2: Update labels in filebrowser service with your domain
# Step 3: Run:
#   mkdir -p traefik letsencrypt
#   docker-compose up -d --build

# 2. MULTIPLE SUBDOMAINS
# ----------------------------------------
# Add more services with different subdomains:
#
#   another-service:
#     image: another-service:latest
#     container_name: another-service
#     networks:
#       - fb_network
#     labels:
#       - "traefik.enable=true"
#       - "traefik.http.routers.another-http.rule=Host(`app.example.com`)"
#       - "traefik.http.routers.another-http.entrypoints=http"
#       - "traefik.http.routers.another-https.rule=Host(`app.example.com`)"
#       - "traefik.http.routers.another-https.entrypoints=https"
#       - "traefik.http.routers.another-https.tls.certresolver=letsencrypt"
#       - "traefik.http.services.another.loadbalancer.server.port=80"

# 3. PATH-BASED ROUTING
# ----------------------------------------
# Route different paths to different services:
#
#   - "traefik.http.routers.filebrowser.rule=Host(`example.com`) && PathPrefix(`/files`)"
#   - "traefik.http.middlewares.filebrowser-stripprefix.stripprefix.prefixes=/files"
#   - "traefik.http.routers.filebrowser-https.middlewares=filebrowser-stripprefix@docker"

# 4. WILD CARD DOMAIN
# ----------------------------------------
# Use wildcard TLS certificate:
#
#   labels:
#     - "traefik.http.routers.filebrowser-https.tls.domains[0].main=example.com"
#     - "traefik.http.routers.filebrowser-https.tls.domains[0].sans=*.example.com"

# ============================================================
# INITIAL SETUP
# ============================================================

# Step 1: Copy this file to docker-compose.yml
#   cp docker-compose.yml.example docker-compose.yml

# Step 2: Create traefik configuration directory
#   mkdir -p traefik letsencrypt

# Step 3: Create traefik.yml (see example above)
#   nano traefik/traefik.yml

# Step 4: Update FileBrowser labels with your domain
#   - Change `files.example.com` to your domain

# Step 5: Update email for Let's Encrypt
#   - Change `your-email@example.com` to your email

# Step 6: Start the stack
#   docker-compose up -d --build

# Step 7: Access FileBrowser at https://files.example.com
#   Access Traefik dashboard at https://traefik.example.com:8080
